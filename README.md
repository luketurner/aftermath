# aftermath

`aftermath` is a Node script for post-processing HTML that was generated by an SSG tool like [Hugo](https://gohugo.io/). Its purpose is to "pre-render" some things that would otherwise be rendered with client-side Javascript, e.g. [KaTeX](https://katex.org/) equations.

Given a directory of HTML files, `aftermath` will apply the following transformations:

1. Replace [mermaid](https://mermaid.js.org/#/) code blocks with compiled SVGs.
2. Replace [KaTeX](https://katex.org/) syntax with compiled SVGs.
3. Replace [D2](https://d2lang.com) code blocks with compiled SVGs.

Because `aftermath` is quite slow for decent sized blogs, I recommend using it for production builds only, where minimal Javascript is desirable. During development, client-side Javascript rendering is probably preferable.

Although designed to work with HTML output by Hugo, in theory `aftermath` doesn't really care where the HTML came from, and could be used with the output from other SSGs (or even handwritten documents!)

> **Warning**
> 
> `aftermath` processes all the HTML using [Cheerio](https://github.com/cheeriojs/cheerio). This may result in some spurious transformation (e.g. changing whitespace or escaping) if the output format of Cheerio's `.html()` is different than the original HTML.
>
> In particular, HTML typographical character references e.g. `&ndash;`, which are generated by the Goldmark markdown renderer's typographer extension, are converted to their un-escaped Unicode equivalent. This aligns with [W3C's recommendation](https://www.w3.org/International/questions/qa-escapes#not) but can cause encoding issues if you don't specify a utf8 charset in your HTML.

## Installation and Usage

We can "install" `aftermath` by adding it as a submodule in our blog's Git repository:

```bash
cd projects/blog
git submodule add https://github.com/luketurner/blog-aftermath.git aftermath
```

The `aftermath` tool is intended to be run in [Docker](https://www.docker.com/) (or equivalent container builder and runtime). Once we've cloned the repo, we can build an `aftermath` image:

```bash
docker build aftermath -t aftermath
```

Building the image is slow, but we only have to do it once.

Now we can run an `aftermath` container:

```bash
docker run aftermath
```

Just running the container like that won't actually do anything useful, though; `aftermath` transforms HTML in-place, but we haven't given it any HTML to transform.

In order for `aftermath` to find our HTML, we need to bind-mount a local directory to the `/home/aftermath/input` directory in the container.

In our case, for compatibility with [Github Pages](https://pages.github.com/), we've set our blog's `publishDir` to `/docs`. So, that's the folder that we want `aftermath` to transform.

The resulting `docker run` call looks like:

```bash
docker run --mount "type=bind,source=$(pwd)/docs,target=/home/aftermath/input" aftermath
```

When doing a production build of our blog, we could use the following script (call it `build.sh`):

```bash
#!/usr/bin/env bash
set -e
hugo
docker run --mount "type=bind,source=$(pwd)/docs,target=/home/aftermath/input" aftermath
```